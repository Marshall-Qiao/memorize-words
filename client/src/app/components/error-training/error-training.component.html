<div class="error-training-container">
  <h1>ðŸ”¥ Error Training</h1>

  <mat-tab-group>
    <!-- Error Analysis Tab -->
    <mat-tab label="Error Analysis">
      <div class="tab-content">
        <!-- Error Stats -->
        <mat-card class="stats-card">
          <mat-card-header>
            <mat-card-title>Error Statistics (Last 30 Days)</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="loadingErrors" class="loading">
              <mat-spinner diameter="30"></mat-spinner>
              <p>Loading error statistics...</p>
            </div>
            
            <div *ngIf="!loadingErrors && errorStats.length > 0" class="stats-grid">
              <div *ngFor="let stat of errorStats" class="stat-item">
                <div class="stat-type">{{ stat.error_type | titlecase }}</div>
                <div class="stat-count">{{ stat.error_count }} errors</div>
                <div class="stat-percentage">{{ stat.percentage }}%</div>
              </div>
            </div>
            
            <div *ngIf="!loadingErrors && errorStats.length === 0" class="no-data">
              <mat-icon>info</mat-icon>
              <p>No error data available</p>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Top Error Words -->
        <mat-card class="top-errors-card">
          <mat-card-header>
            <mat-card-title>Most Challenging Words</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="loadingErrors" class="loading">
              <mat-spinner diameter="30"></mat-spinner>
              <p>Loading challenging words...</p>
            </div>
            
            <div *ngIf="!loadingErrors && topErrors.length > 0" class="top-errors-list">
              <div *ngFor="let error of topErrors.slice(0, 10)" class="error-word-item">
                <div class="word-name">{{ error.word }}</div>
                <div class="error-count">{{ error.error_count }} errors</div>
                <div class="error-percentage">{{ error.error_percentage }}%</div>
              </div>
            </div>
            
            <div *ngIf="!loadingErrors && topErrors.length === 0" class="no-data">
              <mat-icon>info</mat-icon>
              <p>No challenging words found</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Error Training Tab -->
    <mat-tab label="Error Training">
      <div class="tab-content">
        <!-- Training Setup -->
        <mat-card *ngIf="!isTraining" class="setup-card">
          <mat-card-header>
            <mat-card-title>Error Training Setup</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="setup-form">
              <mat-form-field appearance="outline" class="session-select">
                <mat-label>Select Training Session</mat-label>
                <select matNativeControl [(ngModel)]="selectedSessionId" (change)="onSessionChange()">
                  <option value="">Choose a session...</option>
                  <option *ngFor="let session of sessions" [value]="session.id">
                    {{ session.session_name }} ({{ session.error_count || 0 }} errors)
                  </option>
                </select>
              </mat-form-field>

              <div class="settings-row">
                <mat-form-field appearance="outline" class="setting-field">
                  <mat-label>Round Number</mat-label>
                  <input matInput type="number" [(ngModel)]="roundNumber" min="1" max="4">
                </mat-form-field>

                <mat-form-field appearance="outline" class="setting-field">
                  <mat-label>Word Count</mat-label>
                  <input matInput type="number" [(ngModel)]="wordCount" min="5" max="20">
                </mat-form-field>

                <mat-form-field appearance="outline" class="setting-field">
                  <mat-label>Accent</mat-label>
                  <select matNativeControl [(ngModel)]="accent">
                    <option value="us">US English</option>
                    <option value="uk">UK English</option>
                  </select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="setting-field">
                  <mat-label>Speed</mat-label>
                  <input matInput type="number" [(ngModel)]="speed" min="0.5" max="2" step="0.1">
                </mat-form-field>
              </div>

              <div class="action-buttons">
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="generateRandomErrorRound()"
                  [disabled]="!selectedSessionId || loading">
                  <mat-icon>shuffle</mat-icon>
                  Generate Random Error Round
                </button>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Error Rounds List -->
        <mat-card *ngIf="!isTraining && selectedSessionId" class="rounds-card">
          <mat-card-header>
            <mat-card-title>Error Training Rounds</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="loading" class="loading">
              <mat-spinner diameter="30"></mat-spinner>
              <p>Loading error rounds...</p>
            </div>
            
            <div *ngIf="!loading && errorRounds.length > 0" class="rounds-list">
              <div *ngFor="let round of errorRounds" class="round-item">
                <div class="round-info">
                  <div class="round-title">Round {{ round.round_number }}</div>
                  <div class="round-meta">
                    {{ round.word_ids.length }} words â€¢ 
                    {{ round.status | titlecase }} â€¢ 
                    {{ round.created_at | date:'short' }}
                  </div>
                </div>
                <div class="round-actions">
                  <button 
                    mat-button 
                    color="primary"
                    (click)="startErrorTraining(round)"
                    [disabled]="round.status === 'completed'">
                    <mat-icon>play_arrow</mat-icon>
                    {{ round.status === 'completed' ? 'Completed' : 'Start Training' }}
                  </button>
                </div>
              </div>
            </div>
            
            <div *ngIf="!loading && errorRounds.length === 0" class="no-data">
              <mat-icon>info</mat-icon>
              <p>No error rounds found for this session</p>
              <p>Generate a random error round to get started</p>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Training Session -->
        <div *ngIf="isTraining" class="training-session">
          <!-- Progress Bar -->
          <mat-card class="progress-card">
            <mat-card-content>
              <div class="progress-info">
                <span class="progress-text">{{ getCurrentWordProgress() }}</span>
                <span class="round-info">Round {{ currentRound?.round_number }}</span>
              </div>
              <mat-progress-bar 
                mode="determinate" 
                [value]="getProgress()" 
                class="progress-bar">
              </mat-progress-bar>
            </mat-card-content>
          </mat-card>

          <!-- Current Word -->
          <mat-card class="word-card" *ngIf="currentWord">
            <mat-card-content>
              <div class="word-display">
                <div class="word-text" [class.show-answer]="showAnswer">
                  {{ showAnswer ? currentWord.word : '?' }}
                </div>
                <div class="word-meta" *ngIf="showAnswer">
                  <span class="accent-info">{{ accent.toUpperCase() }} pronunciation</span>
                </div>
              </div>

              <div class="word-actions">
                <button mat-icon-button (click)="playCurrentWord()" [title]="'Play pronunciation'">
                  <mat-icon>volume_up</mat-icon>
                </button>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Input Section -->
          <mat-card class="input-card" *ngIf="currentWord && !showAnswer">
            <mat-card-content>
              <mat-form-field appearance="outline" class="answer-input">
                <mat-label>Type the word you heard</mat-label>
                <input 
                  matInput 
                  [(ngModel)]="userInput" 
                  (keyup.enter)="checkAnswer()"
                  placeholder="Type here..."
                  autofocus>
              </mat-form-field>
              <button 
                mat-raised-button 
                color="primary" 
                (click)="checkAnswer()"
                [disabled]="!userInput.trim()">
                Check Answer
              </button>
            </mat-card-content>
          </mat-card>

          <!-- Answer Display -->
          <mat-card class="answer-card" *ngIf="currentWord && showAnswer">
            <mat-card-content>
              <div class="answer-result" [class.correct]="userInput.toLowerCase().trim() === currentWord.word.toLowerCase()">
                <mat-icon *ngIf="userInput.toLowerCase().trim() === currentWord.word.toLowerCase()" class="result-icon correct">
                  check_circle
                </mat-icon>
                <mat-icon *ngIf="userInput.toLowerCase().trim() !== currentWord.word.toLowerCase()" class="result-icon incorrect">
                  cancel
                </mat-icon>
                <div class="result-text">
                  <div *ngIf="userInput.toLowerCase().trim() === currentWord.word.toLowerCase()" class="correct-message">
                    Correct! ðŸŽ‰
                  </div>
                  <div *ngIf="userInput.toLowerCase().trim() !== currentWord.word.toLowerCase()" class="incorrect-message">
                    Incorrect. The correct answer is: <strong>{{ currentWord.word }}</strong>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Countdown -->
          <mat-card class="countdown-card" *ngIf="countdown > 0">
            <mat-card-content>
              <div class="countdown-display">
                <mat-icon>timer</mat-icon>
                <span class="countdown-text">Next in {{ countdown }}s...</span>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Training Controls -->
          <mat-card class="controls-card">
            <mat-card-content>
              <div class="training-controls">
                <button 
                  mat-button 
                  (click)="isPaused ? resumeTraining() : pauseTraining()"
                  [color]="isPaused ? 'primary' : 'accent'">
                  <mat-icon>{{ isPaused ? 'play_arrow' : 'pause' }}</mat-icon>
                  {{ isPaused ? 'Resume' : 'Pause' }}
                </button>
                <button mat-button color="warn" (click)="stopTraining()">
                  <mat-icon>stop</mat-icon>
                  Stop Training
                </button>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>